name: ğŸš€ Build e Deploy para Nexus

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      deploy_only:
        description: 'ğŸš€ Apenas deploy (pular testes e build)'
        required: false
        default: false
        type: boolean

env:
  IMAGE_NAME: tempo-box
  IMAGE_TAG: ${{ github.sha }}
  NEXUS_REGISTRY: ${{ secrets.NEXUS_REPOSITORY }}:${{ secrets.NEXUS_PORT }}
  AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}
  # Cache paths para self-hosted runner
  GRADLE_USER_HOME: /home/apolo/.gradle
  GRADLE_CACHE_DIR: /home/apolo/.gradle-cache/${{ github.repository }}
  DOCKER_CACHE_DIR: /home/apolo/.docker-cache/${{ github.repository }}

jobs:
  # ğŸ§ª Job 1: Testes
  test:
    name: ğŸ§ª Executar Testes
    runs-on: [self-hosted, a3s-ubt-srv-maranguape-01]
    if: ${{ !inputs.deploy_only }}
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: â˜• Configurar JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ğŸ“¦ Configurar diretÃ³rios de cache do Gradle
      run: |
        echo "ğŸ”§ Configurando cache persistente do Gradle..."
        mkdir -p ${{ env.GRADLE_CACHE_DIR }}/caches
        mkdir -p ${{ env.GRADLE_CACHE_DIR }}/wrapper
        mkdir -p ${{ env.GRADLE_USER_HOME }}
        
        # Criar symlinks para cache persistente se nÃ£o existirem
        if [ ! -L "${{ env.GRADLE_USER_HOME }}/caches" ]; then
          ln -sf ${{ env.GRADLE_CACHE_DIR }}/caches ${{ env.GRADLE_USER_HOME }}/caches
        fi
        if [ ! -L "${{ env.GRADLE_USER_HOME }}/wrapper" ]; then
          ln -sf ${{ env.GRADLE_CACHE_DIR }}/wrapper ${{ env.GRADLE_USER_HOME }}/wrapper
        fi
        
        echo "âœ… Cache do Gradle pronto em ${{ env.GRADLE_CACHE_DIR }}"

    - name: ğŸ”§ Tornar gradlew executÃ¡vel
      run: chmod +x ./gradlew

    - name: ğŸ§ª Executar testes
      run: ./gradlew test --parallel --build-cache

    - name: ğŸ“Š Upload dos resultados dos testes
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: build/reports/tests/test/
        retention-days: 7

  # ğŸ—ï¸ Job 2: Build da AplicaÃ§Ã£o
  build:
    name: ğŸ—ï¸ Build da AplicaÃ§Ã£o
    runs-on: [self-hosted, a3s-ubt-srv-maranguape-01]
    needs: [test]
    if: always() && (needs.test.result == 'success' || inputs.deploy_only)
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: â˜• Configurar JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ğŸ“¦ Configurar diretÃ³rios de cache do Gradle
      run: |
        echo "ğŸ”§ Usando cache persistente do Gradle..."
        mkdir -p ${{ env.GRADLE_CACHE_DIR }}/caches
        mkdir -p ${{ env.GRADLE_CACHE_DIR }}/wrapper
        mkdir -p ${{ env.GRADLE_USER_HOME }}
        
        # Usar cache existente via symlinks
        if [ ! -L "${{ env.GRADLE_USER_HOME }}/caches" ]; then
          ln -sf ${{ env.GRADLE_CACHE_DIR }}/caches ${{ env.GRADLE_USER_HOME }}/caches
        fi
        if [ ! -L "${{ env.GRADLE_USER_HOME }}/wrapper" ]; then
          ln -sf ${{ env.GRADLE_CACHE_DIR }}/wrapper ${{ env.GRADLE_USER_HOME }}/wrapper
        fi
        
        echo "âœ… Cache do Gradle vinculado, tamanho: $(du -sh ${{ env.GRADLE_CACHE_DIR }} 2>/dev/null || echo 'vazio')"

    - name: ğŸ”§ Tornar gradlew executÃ¡vel
      run: chmod +x ./gradlew

    - name: ğŸ—ï¸ Build da aplicaÃ§Ã£o
      run: ./gradlew build -x test --parallel --build-cache

    - name: ğŸ“¦ Upload dos artefatos do build
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: build/libs/
        retention-days: 7

  # ğŸ³ Job 3: Build e Push do Docker
  docker:
    name: ğŸ³ Build e Push do Docker
    runs-on: [self-hosted, a3s-ubt-srv-maranguape-01]
    needs: [build]
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ“¦ Download dos artefatos do build
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: build/libs/

    - name: ğŸ³ Configurar Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Login no Nexus Docker Registry
      run: |
        echo "ğŸ” Fazendo login no Nexus Registry..."
        echo "${{ secrets.NEXUS_PASSWORD }}" | docker login ${{ env.NEXUS_REGISTRY }} -u "${{ secrets.NEXUS_USER }}" --password-stdin

    - name: ğŸ“¦ Configurar cache do Docker
      run: |
        echo "ğŸ”§ Configurando cache persistente do Docker..."
        mkdir -p ${{ env.DOCKER_CACHE_DIR }}
        echo "âœ… Cache do Docker pronto em ${{ env.DOCKER_CACHE_DIR }}"

    - name: ğŸ—ï¸ Build da imagem Docker
      run: |
        echo "ğŸ—ï¸ Fazendo build das imagens Docker com cache persistente..."
        docker buildx build \
          --cache-from=type=local,src=${{ env.DOCKER_CACHE_DIR }} \
          --cache-to=type=local,dest=${{ env.DOCKER_CACHE_DIR }},mode=max \
          --build-arg AUTH_TOKEN="${{ env.AUTH_TOKEN }}" \
          --build-arg APP_VERSION="1.0.0" \
          --tag ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
          --tag ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
          --load \
          .
        
        echo "ğŸ“Š Tamanho do cache: $(du -sh ${{ env.DOCKER_CACHE_DIR }} 2>/dev/null || echo 'vazio')"

    - name: ğŸš€ Push das imagens Docker para o Nexus
      run: |
        echo "ğŸš€ Enviando imagens para o Nexus..."
        docker push ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        docker push ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        echo "âœ… Imagens enviadas com sucesso!"

  # ğŸ§¹ Job 4: Limpeza
  cleanup:
    name: ğŸ§¹ Limpeza
    runs-on: [self-hosted, a3s-ubt-srv-maranguape-01]
    needs: [docker]
    if: always()
    
    steps:
    - name: ğŸ§¹ Limpeza das imagens Docker locais
      run: |
        echo "ğŸ§¹ Limpando imagens Docker locais..."
        docker rmi ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} || true
        docker rmi ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:latest || true
        
        # Limpar apenas imagens dangling, manter cache
        docker image prune -f || true
        
        echo "ğŸ“Š Tamanhos dos caches apÃ³s limpeza:"
        echo "Gradle: $(du -sh ${{ env.GRADLE_CACHE_DIR }} 2>/dev/null || echo 'vazio')"
        echo "Docker: $(du -sh ${{ env.DOCKER_CACHE_DIR }} 2>/dev/null || echo 'vazio')"
        echo "âœ… Limpeza concluÃ­da!"

  # ğŸ“Š Job 5: Resumo
  summary:
    name: ğŸ“Š Resumo da Pipeline
    runs-on: [self-hosted, a3s-ubt-srv-maranguape-01]
    needs: [test, build, docker, cleanup]
    if: always()
    
    steps:
    - name: ğŸ“Š Resumo da Pipeline
      run: |
        echo "ğŸ‰ Resumo da ExecuÃ§Ã£o da Pipeline"
        echo "================================"
        echo "ğŸ§ª Testes: ${{ needs.test.result || 'pulado' }}"
        echo "ğŸ—ï¸  Build: ${{ needs.build.result || 'pulado' }}"
        echo "ğŸ³ Docker: ${{ needs.docker.result || 'pulado' }}"
        echo "ğŸ§¹ Limpeza: ${{ needs.cleanup.result || 'pulado' }}"
        echo "================================"
        if [[ "${{ needs.docker.result }}" == "success" ]]; then
          echo "âœ… Deploy realizado com sucesso! Imagens disponÃ­veis em:"
          echo "ğŸ“¦ ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "ğŸ“¦ ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
        else
          echo "âŒ Deploy falhou ou foi pulado"
        fi