name: ğŸš€ Build and Deploy to Nexus

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      deploy_only:
        description: 'ğŸš€ Deploy only (skip tests and build)'
        required: false
        default: false
        type: boolean

env:
  IMAGE_NAME: tempo-box
  IMAGE_TAG: ${{ github.sha }}
  NEXUS_REGISTRY: ${{ secrets.NEXUS_REPOSITORY }}:${{ secrets.NEXUS_PORT }}

jobs:
  # ğŸ§ª Job 1: Tests
  test:
    name: ğŸ§ª Run Tests
    runs-on: [self-hosted, a3s-ubt-srv-maranguape-01]
    if: ${{ !inputs.deploy_only }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ğŸ“¦ Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: ğŸ”§ Make gradlew executable
      run: chmod +x ./gradlew

    - name: ğŸ§ª Run tests
      run: ./gradlew test --parallel --build-cache

    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: build/reports/tests/test/
        retention-days: 7

  # ğŸ—ï¸ Job 2: Build Application
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: [self-hosted, a3s-ubt-srv-maranguape-01]
    needs: [test]
    if: always() && (needs.test.result == 'success' || inputs.deploy_only)
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ğŸ“¦ Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: ğŸ”§ Make gradlew executable
      run: chmod +x ./gradlew

    - name: ğŸ—ï¸ Build application
      run: ./gradlew build -x test --parallel --build-cache

    - name: ğŸ“¦ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: build/libs/
        retention-days: 7

  # ğŸ³ Job 3: Docker Build & Push
  docker:
    name: ğŸ³ Docker Build & Push
    runs-on: [self-hosted, a3s-ubt-srv-maranguape-01]
    needs: [build]
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: build/libs/

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Login to Nexus Docker Registry
      run: |
        echo "ğŸ” Logging into Nexus Registry..."
        echo "${{ secrets.NEXUS_PASSWORD }}" | docker login ${{ env.NEXUS_REGISTRY }} -u "${{ secrets.NEXUS_USER }}" --password-stdin

    - name: ğŸ—ï¸ Build Docker image
      run: |
        echo "ğŸ—ï¸ Building Docker images..."
        docker buildx build \
          --cache-from=type=local,src=/tmp/.buildx-cache \
          --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
          --tag ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
          --tag ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
          --load \
          .

    - name: ğŸš€ Push Docker images to Nexus
      run: |
        echo "ğŸš€ Pushing images to Nexus..."
        docker push ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        docker push ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        echo "âœ… Images pushed successfully!"

    - name: ğŸ—‚ï¸ Move cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache || true

  # ğŸ§¹ Job 4: Cleanup
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: [self-hosted, a3s-ubt-srv-maranguape-01]
    needs: [docker]
    if: always()
    
    steps:
    - name: ğŸ§¹ Cleanup Docker images
      run: |
        echo "ğŸ§¹ Cleaning up local Docker images..."
        docker rmi ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} || true
        docker rmi ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:latest || true
        docker system prune -f || true
        echo "âœ… Cleanup completed!"

  # ğŸ“Š Job 5: Summary
  summary:
    name: ğŸ“Š Pipeline Summary
    runs-on: [self-hosted, a3s-ubt-srv-maranguape-01]
    needs: [test, build, docker, cleanup]
    if: always()
    
    steps:
    - name: ğŸ“Š Pipeline Summary
      run: |
        echo "ğŸ‰ Pipeline Execution Summary"
        echo "================================"
        echo "ğŸ§ª Tests: ${{ needs.test.result || 'skipped' }}"
        echo "ğŸ—ï¸  Build: ${{ needs.build.result || 'skipped' }}"
        echo "ğŸ³ Docker: ${{ needs.docker.result || 'skipped' }}"
        echo "ğŸ§¹ Cleanup: ${{ needs.cleanup.result || 'skipped' }}"
        echo "================================"
        if [[ "${{ needs.docker.result }}" == "success" ]]; then
          echo "âœ… Deploy successful! Images available at:"
          echo "ğŸ“¦ ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "ğŸ“¦ ${{ env.NEXUS_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
        else
          echo "âŒ Deploy failed or skipped"
        fi