name: üßπ Limpeza de Cache

on:
  workflow_dispatch:
    inputs:
      cleanup_type:
        description: 'üóÇÔ∏è Tipo de limpeza de cache'
        required: true
        default: 'gradle'
        type: choice
        options:
        - gradle
        - docker
        - all
  schedule:
    # Limpeza autom√°tica toda segunda √†s 02:00
    - cron: '0 2 * * 1'

env:
  GRADLE_CACHE_DIR: /home/apolo/.gradle-cache/${{ github.repository }}
  DOCKER_CACHE_DIR: /home/apolo/.docker-cache/${{ github.repository }}

jobs:
  cache-cleanup:
    name: üßπ Limpeza de Cache
    runs-on: [self-hosted, a3s-ubt-srv-maranguape-01]
    
    steps:
    - name: üìä Tamanho do cache antes da limpeza
      run: |
        echo "üìä Tamanhos dos caches antes da limpeza:"
        echo "Gradle: $(du -sh ${{ env.GRADLE_CACHE_DIR }} 2>/dev/null || echo 'n√£o encontrado')"
        echo "Docker: $(du -sh ${{ env.DOCKER_CACHE_DIR }} 2>/dev/null || echo 'n√£o encontrado')"
        echo "Uso total do disco: $(df -h /home/apolo | tail -1)"

    - name: üßπ Limpeza do cache do Gradle
      if: ${{ inputs.cleanup_type == 'gradle' || inputs.cleanup_type == 'all' || github.event_name == 'schedule' }}
      run: |
        echo "üßπ Limpando cache do Gradle..."
        if [ -d "${{ env.GRADLE_CACHE_DIR }}" ]; then
          # Manter apenas os √∫ltimos 7 dias de cache
          find ${{ env.GRADLE_CACHE_DIR }} -type f -mtime +7 -delete || true
          find ${{ env.GRADLE_CACHE_DIR }} -type d -empty -delete || true
          echo "‚úÖ Cache do Gradle limpo"
        else
          echo "‚ÑπÔ∏è Diret√≥rio do cache do Gradle n√£o encontrado"
        fi

    - name: üßπ Limpeza do cache do Docker
      if: ${{ inputs.cleanup_type == 'docker' || inputs.cleanup_type == 'all' || github.event_name == 'schedule' }}
      run: |
        echo "üßπ Limpando cache do Docker..."
        if [ -d "${{ env.DOCKER_CACHE_DIR }}" ]; then
          # Manter apenas os √∫ltimos 3 dias de cache Docker
          find ${{ env.DOCKER_CACHE_DIR }} -type f -mtime +3 -delete || true
          find ${{ env.DOCKER_CACHE_DIR }} -type d -empty -delete || true
          echo "‚úÖ Cache do Docker limpo"
        else
          echo "‚ÑπÔ∏è Diret√≥rio do cache do Docker n√£o encontrado"
        fi
        
        # Limpeza adicional do sistema Docker
        docker system prune -f --filter "until=72h" || true

    - name: üìä Tamanho do cache ap√≥s limpeza
      run: |
        echo "üìä Tamanhos dos caches ap√≥s limpeza:"
        echo "Gradle: $(du -sh ${{ env.GRADLE_CACHE_DIR }} 2>/dev/null || echo 'n√£o encontrado')"
        echo "Docker: $(du -sh ${{ env.DOCKER_CACHE_DIR }} 2>/dev/null || echo 'n√£o encontrado')"
        echo "Uso total do disco: $(df -h /home/apolo | tail -1)"
        echo "‚úÖ Limpeza de cache conclu√≠da!"